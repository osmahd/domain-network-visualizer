<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Network Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="file"],
        select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            cursor: pointer;
            background-color: white;
        }

        select:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: #764ba2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #666;
        }

        button.secondary:hover:not(:disabled) {
            background: #555;
        }

        .visualization-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 600px;
        }

        #network {
            width: 100%;
            height: 600px;
            border-radius: 4px;
            background: #f9f9f9;
        }

        .stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }

        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            display: block;
            border-left: 4px solid #c62828;
        }

        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
            border-left: 4px solid #2e7d32;
        }

        .message.info {
            background: #e3f2fd;
            color: #1565c0;
            display: block;
            border-left: 4px solid #1565c0;
        }

        .legend {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .legend-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-text {
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .control-group {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 24px;
            }

            #network {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Domain Network Visualizer</h1>
            <p class="subtitle">Upload a CSV file with domain data to visualize network relationships</p>
        </div>

        <div id="message" class="message"></div>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="csvFile">Upload CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" />
                </div>

                <div class="control-item">
                    <label for="sourceColumn">Source Column</label>
                    <select id="sourceColumn" disabled>
                        <option value="">Select a column...</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="targetColumn">Target Column</label>
                    <select id="targetColumn" disabled>
                        <option value="">Select a column...</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="valueColumn">Value Column (Optional)</label>
                    <select id="valueColumn" disabled>
                        <option value="">Select a column...</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button id="visualizeBtn" disabled>Visualize Network</button>
                <button id="resetBtn" class="secondary">Reset</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">Total Nodes</div>
                    <div class="stat-value" id="nodeCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Links</div>
                    <div class="stat-value" id="linkCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Data Rows</div>
                    <div class="stat-value" id="rowCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Columns</div>
                    <div class="stat-value" id="columnCount">0</div>
                </div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">Legend</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #667eea;"></div>
                    <div class="legend-text">Nodes - Sized by degree</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ccc;"></div>
                    <div class="legend-text">Links - Connection strength</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <div class="legend-text">Hub nodes (high degree)</div>
                </div>
            </div>
        </div>

        <div class="visualization-container">
            <svg id="network"></svg>
        </div>
    </div>

    <script>
        let csvData = null;
        let columns = [];
        let currentVisualization = null;

        const csvFile = document.getElementById('csvFile');
        const sourceColumn = document.getElementById('sourceColumn');
        const targetColumn = document.getElementById('targetColumn');
        const valueColumn = document.getElementById('valueColumn');
        const visualizeBtn = document.getElementById('visualizeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const messageDiv = document.getElementById('message');

        // Event Listeners
        csvFile.addEventListener('change', handleFileUpload);
        sourceColumn.addEventListener('change', updateVisualizationState);
        targetColumn.addEventListener('change', updateVisualizationState);
        valueColumn.addEventListener('change', updateVisualizationState);
        visualizeBtn.addEventListener('click', visualizeNetwork);
        resetBtn.addEventListener('click', resetApp);

        function showMessage(message, type = 'info') {
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            setTimeout(() => {
                messageDiv.className = 'message';
            }, 5000);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        showMessage('CSV file is empty', 'error');
                        return;
                    }

                    csvData = results.data;
                    columns = results.meta.fields || Object.keys(results.data[0] || {});

                    // Trim whitespace from column names
                    columns = columns.map(col => col.trim());

                    // Update statistics
                    document.getElementById('rowCount').textContent = csvData.length;
                    document.getElementById('columnCount').textContent = columns.length;

                    // Populate column dropdowns
                    populateColumnDropdowns();

                    showMessage(`CSV loaded successfully! ${csvData.length} rows, ${columns.length} columns`, 'success');
                    updateVisualizationState();
                },
                error: function(error) {
                    showMessage(`Error parsing CSV: ${error.message}`, 'error');
                }
            });
        }

        function populateColumnDropdowns() {
            // Clear existing options (except the first placeholder)
            [sourceColumn, targetColumn, valueColumn].forEach(dropdown => {
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
            });

            // Add columns to dropdowns
            columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;

                sourceColumn.appendChild(option.cloneNode(true));
                targetColumn.appendChild(option.cloneNode(true));
                valueColumn.appendChild(option.cloneNode(true));
            });

            // Enable dropdowns
            sourceColumn.disabled = false;
            targetColumn.disabled = false;
            valueColumn.disabled = false;

            // Auto-select first two columns as source and target if available
            if (columns.length >= 2) {
                sourceColumn.value = columns[0];
                targetColumn.value = columns[1];
                if (columns.length >= 3) {
                    valueColumn.value = columns[2];
                }
            }
        }

        function updateVisualizationState() {
            const sourceSelected = sourceColumn.value !== '';
            const targetSelected = targetColumn.value !== '';
            const validSelection = sourceSelected && targetSelected && sourceColumn.value !== targetColumn.value;
            visualizeBtn.disabled = !validSelection;
        }

        function visualizeNetwork() {
            if (!csvData || !sourceColumn.value || !targetColumn.value) {
                showMessage('Please select source and target columns', 'error');
                return;
            }

            if (sourceColumn.value === targetColumn.value) {
                showMessage('Source and target columns must be different', 'error');
                return;
            }

            try {
                const nodes = new Map();
                const links = [];

                // Process data
                csvData.forEach(row => {
                    const source = String(row[sourceColumn.value] || '').trim();
                    const target = String(row[targetColumn.value] || '').trim();
                    const value = valueColumn.value ? parseFloat(row[valueColumn.value]) : 1;

                    if (source && target) {
                        // Add nodes
                        if (!nodes.has(source)) {
                            nodes.set(source, { id: source });
                        }
                        if (!nodes.has(target)) {
                            nodes.set(target, { id: target });
                        }

                        // Add link
                        links.push({
                            source: source,
                            target: target,
                            value: isNaN(value) ? 1 : Math.max(0.5, value)
                        });
                    }
                });

                // Create visualization
                createNetworkVisualization(Array.from(nodes.values()), links);

                // Update statistics
                document.getElementById('nodeCount').textContent = nodes.size;
                document.getElementById('linkCount').textContent = links.length;

                showMessage('Network visualization created successfully!', 'success');
            } catch (error) {
                showMessage(`Error creating visualization: ${error.message}`, 'error');
            }
        }

        function createNetworkVisualization(nodes, links) {
            const width = document.getElementById('network').clientWidth;
            const height = 600;

            // Clear previous visualization
            d3.select('#network').selectAll('*').remove();

            const svg = d3.select('#network')
                .attr('width', width)
                .attr('height', height);

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(100)
                    .strength(0.5))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Create arrow markers for links
            svg.append('defs').selectAll('marker')
                .data(['default'])
                .enter()
                .append('marker')
                .attr('id', d => `arrow-${d}`)
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#999');

            // Create links
            const link = svg.selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', '#ccc')
                .attr('stroke-width', d => Math.sqrt(d.value) * 2)
                .attr('marker-end', 'url(#arrow-default)')
                .attr('opacity', 0.6);

            // Calculate node degrees
            const nodeDegree = new Map();
            links.forEach(link => {
                nodeDegree.set(link.source.id || link.source, (nodeDegree.get(link.source.id || link.source) || 0) + 1);
                nodeDegree.set(link.target.id || link.target, (nodeDegree.get(link.target.id || link.target) || 0) + 1);
            });

            // Create nodes
            const node = svg.selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('r', d => {
                    const degree = nodeDegree.get(d.id) || 0;
                    return Math.max(5, Math.sqrt(degree) * 5);
                })
                .attr('fill', d => {
                    const degree = nodeDegree.get(d.id) || 0;
                    return degree > 5 ? '#e74c3c' : '#667eea';
                })
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));

            // Create labels
            const label = svg.selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.3em')
                .attr('pointer-events', 'none')
                .text(d => d.id)
                .style('opacity', 0.7);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // Drag functions
            function dragStarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragEnded(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // Add zoom functionality
            const zoom = d3.zoom()
                .on('zoom', (event) => {
                    svg.selectAll('line,circle,text').attr('transform', event.transform);
                });

            svg.call(zoom);

            currentVisualization = { simulation, svg };
        }

        function resetApp() {
            csvData = null;
            columns = [];
            csvFile.value = '';
            sourceColumn.value = '';
            targetColumn.value = '';
            valueColumn.value = '';
            sourceColumn.disabled = true;
            targetColumn.disabled = true;
            valueColumn.disabled = true;
            visualizeBtn.disabled = true;

            [sourceColumn, targetColumn, valueColumn].forEach(dropdown => {
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
            });

            document.getElementById('nodeCount').textContent = '0';
            document.getElementById('linkCount').textContent = '0';
            document.getElementById('rowCount').textContent = '0';
            document.getElementById('columnCount').textContent = '0';

            d3.select('#network').selectAll('*').remove();
            showMessage('Application reset', 'info');
        }
    </script>
</body>
</html>
