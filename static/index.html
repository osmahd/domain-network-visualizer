<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Domain Network Visualizer</title>
  <style>
    html,body,#cy{height:80vh;width:100%;margin:0;padding:0}
    #controls { padding: 12px; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="file" type="file" accept=".csv" />
    <label for="weightSelect">Weight column:</label>
    <select id="weightSelect"></select>
  </div>
  <div id="cy"></div>

  <!-- Cytoscape via CDN -->
  <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const fileEl = document.getElementById('file');
    const weightSelect = document.getElementById('weightSelect');
    let rows = [];

    fileEl.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      Papa.parse(f, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: results => {
          rows = results.data;
          if (rows.length === 0) {
            alert('No rows parsed from CSV.');
            return;
          }
          populateWeightOptions(rows[0]);
          renderGraph(rows, weightSelect.value || null);
        }
      });
    });

    function populateWeightOptions(sampleRow) {
      weightSelect.innerHTML = '';
      Object.keys(sampleRow).forEach(k => {
        const option = document.createElement('option');
        option.value = k;
        option.textContent = k;
        weightSelect.appendChild(option);
      });
      weightSelect.addEventListener('change', () => renderGraph(rows, weightSelect.value));
    }

    function renderGraph(rows, weightKey) {
      // Expected CSV usage:
      // - columns for source domain: "domain" or "source"
      // - columns for target domain: "target_domain" or "target"
      // - arbitrary numeric columns (e.g., nbr_links_to_target, nbr_dr) available as weightKey
      const nodesMap = new Map();
      const elements = [];
      rows.forEach((r, i) => {
        const src = (r.domain || r.source || r.Source || '').trim();
        const tgt = (r.target_domain || r.target || r.Target || '').trim();
        if (!src || !tgt) return;
        if (!nodesMap.has(src)) { nodesMap.set(src, true); elements.push({ data: { id: src, label: src } }); }
        if (!nodesMap.has(tgt)) { nodesMap.set(tgt, true); elements.push({ data: { id: tgt, label: tgt } }); }
        const raw = r[weightKey];
        const w = (weightKey && typeof raw === 'number') ? raw : (weightKey && raw !== undefined && !isNaN(Number(raw)) ? Number(raw) : 1);
        elements.push({ data: { id: src + '->' + tgt + ':' + i, source: src, target: tgt, weight: w } });
      });

      // destroy previous instance if any
      if (window._cy) { window._cy.destroy(); window._cy = null; }

      window._cy = cytoscape({
        container: document.getElementById('cy'),
        elements,
        style: [
          { selector: 'node', style: { 'label': 'data(label)', 'width': 24, 'height': 24, 'background-color': '#1f78b4', 'color': '#fff', 'text-valign': 'center', 'text-halign': 'center' } },
          { selector: 'edge', style: { 'width': 'mapData(weight, 0, 100, 1, 8)', 'line-color': '#888', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#888' } }
        ],
        layout: { name: 'cose' }
      });

      // simple click: show data
      window._cy.on('tap', 'node', evt => {
        const node = evt.target;
        alert('Node: ' + node.id());
      });
    }
  </script>
</body>
</html>